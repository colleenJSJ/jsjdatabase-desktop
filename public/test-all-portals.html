<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test All Portal Types</title>
  <style>
    body {
      font-family: system-ui;
      max-width: 1200px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    button {
      background: #4a9eff;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #357abd;
    }
    .section {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #444;
    }
    pre {
      background: #111;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .warning { color: #facc15; }
    h2 { color: #60a5fa; font-size: 18px; }
    h3 { color: #94a3b8; font-size: 14px; }
  </style>
</head>
<body>
  <h1>Test All Portal Types</h1>
  <p>Test portal creation for Medical, Academic, and Pet portals with proper password sync and owner assignment.</p>
  
  <div class="grid">
    <!-- Medical Portal Section -->
    <div class="section">
      <h2>Medical Portal (Health)</h2>
      
      <div>
        <h3>1. Create Medical Portal</h3>
        <button onclick="createMedicalPortal()">Create Portal</button>
        <pre id="medical-create-result"></pre>
      </div>
      
      <div>
        <h3>2. Verify Password</h3>
        <button onclick="verifyMedicalPassword()">Check Password</button>
        <pre id="medical-verify-result"></pre>
      </div>
    </div>
    
    <!-- Academic Portal Section -->
    <div class="section">
      <h2>Academic Portal (J3)</h2>
      
      <div>
        <h3>1. Create Academic Portal</h3>
        <button onclick="createAcademicPortal()">Create Portal</button>
        <pre id="academic-create-result"></pre>
      </div>
      
      <div>
        <h3>2. Verify Password</h3>
        <button onclick="verifyAcademicPassword()">Check Password</button>
        <pre id="academic-verify-result"></pre>
      </div>
    </div>
    
    <!-- Pet Portal Section -->
    <div class="section">
      <h2>Pet Portal</h2>
      
      <div>
        <h3>1. Create Pet Portal</h3>
        <button onclick="createPetPortal()">Create Portal</button>
        <pre id="pet-create-result"></pre>
      </div>
      
      <div>
        <h3>2. Verify Password</h3>
        <button onclick="verifyPetPassword()">Check Password</button>
        <pre id="pet-verify-result"></pre>
      </div>
    </div>
  </div>
  
  <div class="section" style="margin-top: 20px;">
    <h2>All Passwords</h2>
    <button onclick="checkAllPasswords()">Refresh Password List</button>
    <pre id="all-passwords-result"></pre>
  </div>

  <script>
    let medicalPortalId = null;
    let academicPortalId = null;
    let petPortalId = null;
    
    async function createMedicalPortal() {
      const resultEl = document.getElementById('medical-create-result');
      resultEl.textContent = 'Creating medical portal...';
      
      try {
        // Get Susan Johnson's family member ID (she should be a patient)
        const susanId = '121ccae9-7c2e-4572-bb4f-400b59959542'; // Susan Johnson's ID from earlier
        
        const response = await fetch('/api/medical-portals', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: 'Test Medical Portal',
            portal_url: 'https://medical-test.com',
            username: 'susan.medical',
            password: 'MedicalTest123!',
            patient_ids: [susanId], // Susan as patient/owner
            notes: 'Test medical portal with Susan as owner'
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          medicalPortalId = data.portal?.id;
          resultEl.innerHTML = `<span class="success">✅ Created!</span>\n` +
            `ID: ${data.portal?.id}\n` +
            `Name: ${data.portal?.portal_name}`;
        } else {
          resultEl.innerHTML = `<span class="error">❌ Failed: ${data.error}</span>`;
        }
      } catch (error) {
        resultEl.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
      }
    }
    
    async function createAcademicPortal() {
      const resultEl = document.getElementById('academic-create-result');
      resultEl.textContent = 'Creating academic portal...';
      
      try {
        // Use test child IDs - you may need to adjust these
        const response = await fetch('/api/academic-portals', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            portal_name: 'Test School Portal',
            portal_url: 'https://school-test.com',
            username: 'parent.academic',
            password: 'AcademicTest123!',
            children: [], // Empty for test, will use current user as owner
            notes: 'Test academic portal'
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          academicPortalId = data.id;
          resultEl.innerHTML = `<span class="success">✅ Created!</span>\n` +
            `ID: ${data.id}\n` +
            `Name: ${data.portal_name}`;
        } else {
          resultEl.innerHTML = `<span class="error">❌ Failed: ${data.error}</span>`;
        }
      } catch (error) {
        resultEl.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
      }
    }
    
    async function createPetPortal() {
      const resultEl = document.getElementById('pet-create-result');
      resultEl.textContent = 'Creating pet portal...';
      
      try {
        const response = await fetch('/api/pet-portals', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            portal_name: 'Test Vet Portal',
            portal_url: 'https://vet-test.com',
            username: 'pet.owner',
            password: 'PetTest123!',
            provider_name: 'Test Veterinary Clinic',
            pet_id: null, // No specific pet, will use current user as owner
            notes: 'Test pet portal'
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          petPortalId = data.portal?.id;
          resultEl.innerHTML = `<span class="success">✅ Created!</span>\n` +
            `ID: ${data.portal?.id}\n` +
            `Name: ${data.portal?.portal_name}`;
        } else {
          resultEl.innerHTML = `<span class="error">❌ Failed: ${data.error}</span>`;
        }
      } catch (error) {
        resultEl.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
      }
    }
    
    async function verifyMedicalPassword() {
      const resultEl = document.getElementById('medical-verify-result');
      await verifyPassword('Test Medical Portal', resultEl);
    }
    
    async function verifyAcademicPassword() {
      const resultEl = document.getElementById('academic-verify-result');
      await verifyPassword('Test School Portal', resultEl);
    }
    
    async function verifyPetPassword() {
      const resultEl = document.getElementById('pet-verify-result');
      await verifyPassword('Test Vet Portal', resultEl);
    }
    
    async function verifyPassword(portalName, resultEl) {
      resultEl.textContent = 'Checking password...';
      
      try {
        const response = await fetch('/api/passwords');
        const data = await response.json();
        
        const password = data.passwords?.find(p => 
          p.service_name === portalName || 
          p.title === portalName
        );
        
        if (password) {
          resultEl.innerHTML = `<span class="success">✅ Found!</span>\n` +
            `Category: ${password.category}\n` +
            `Owner: ${password.owner_id?.substring(0, 8)}...\n` +
            `Source: ${password.source}`;
        } else {
          resultEl.innerHTML = `<span class="warning">⚠️ Not found</span>`;
        }
      } catch (error) {
        resultEl.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
      }
    }
    
    async function checkAllPasswords() {
      const resultEl = document.getElementById('all-passwords-result');
      resultEl.textContent = 'Fetching all passwords...';
      
      try {
        const response = await fetch('/api/passwords');
        const data = await response.json();
        
        const testPasswords = data.passwords?.filter(p => 
          p.service_name?.includes('Test') || 
          p.title?.includes('Test')
        ) || [];
        
        if (testPasswords.length > 0) {
          resultEl.innerHTML = `<span class="success">Found ${testPasswords.length} test passwords:</span>\n` +
            testPasswords.map(p => 
              `• ${p.service_name || p.title} (${p.category}) - Owner: ${p.owner_id?.substring(0, 8)}...`
            ).join('\n');
        } else {
          resultEl.innerHTML = `<span class="warning">No test passwords found</span>`;
        }
      } catch (error) {
        resultEl.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
      }
    }
  </script>
</body>
</html>