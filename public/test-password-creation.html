<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Password Creation</title>
  <style>
    body {
      font-family: system-ui;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    button {
      background: #4a9eff;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #357abd;
    }
    .section {
      background: #2a2a2a;
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      border: 1px solid #444;
    }
    pre {
      background: #111;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .warning { color: #facc15; }
    h2 { color: #60a5fa; }
  </style>
</head>
<body>
  <h1>Test Password Creation</h1>
  
  <div class="section">
    <h2>1. Get Family Members</h2>
    <button onclick="getFamilyMembers()">Get Family Members</button>
    <pre id="family-result"></pre>
  </div>
  
  <div class="section">
    <h2>2. Create Test Password</h2>
    <button onclick="createTestPassword()">Create Basic Password</button>
    <button onclick="createSharedPassword()">Create Shared Password</button>
    <pre id="create-result"></pre>
  </div>
  
  <div class="section">
    <h2>3. Check Password List</h2>
    <button onclick="checkPasswords()">Check Passwords</button>
    <pre id="list-result"></pre>
  </div>

  <script>
    let familyMembers = [];
    
    async function getFamilyMembers() {
      const resultEl = document.getElementById('family-result');
      resultEl.textContent = 'Fetching family members...';
      
      try {
        // Get current user info first
        const userResponse = await fetch('/api/auth/me');
        const userData = await userResponse.json();
        
        if (!userResponse.ok) {
          resultEl.innerHTML = `<span class="error">❌ Not authenticated. Please log in first.</span>`;
          return;
        }
        
        // For testing, create mock family members
        familyMembers = [
          { id: 'fm-1', name: 'John Johnson', email: 'john@example.com' },
          { id: 'fm-2', name: 'Susan Johnson', email: 'susan@example.com' },
          { id: 'fm-3', name: 'Claire Johnson', email: null },
        ];
        
        resultEl.innerHTML = `<span class="success">✅ Current User: ${userData.email}</span>\n` +
          'Mock Family Members:\n' +
          familyMembers.map(m => `  - ${m.name} (${m.id})`).join('\n');
      } catch (error) {
        resultEl.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
      }
    }
    
    async function createTestPassword() {
      const resultEl = document.getElementById('create-result');
      resultEl.textContent = 'Creating test password...';
      
      try {
        const response = await fetch('/api/passwords', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: 'Test Password Entry',
            username: 'testuser@example.com',
            password: 'TestPassword123!',
            url: 'https://example.com',
            category: 'Personal',
            notes: 'Test password created for debugging',
            shared_with: [] // No sharing - just for current user
          })
        });
        
        if (!response.ok) {
          const data = await response.json();
          resultEl.innerHTML = `<span class="error">❌ Failed to create password:\n${JSON.stringify(data, null, 2)}</span>`;
          console.error('Creation failed:', data);
        } else {
          const data = await response.json();
          resultEl.innerHTML = `<span class="success">✅ Password created successfully!</span>\n` +
            `ID: ${data.id}\n` +
            `Service: ${data.service_name}\n` +
            `Category: ${data.category}\n` +
            `Owner: ${data.owner_id}`;
        }
      } catch (error) {
        resultEl.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
        console.error('Error:', error);
      }
    }
    
    async function createSharedPassword() {
      const resultEl = document.getElementById('create-result');
      
      if (familyMembers.length === 0) {
        resultEl.innerHTML = `<span class="warning">⚠️ Get family members first</span>`;
        return;
      }
      
      resultEl.textContent = 'Creating shared password...';
      
      try {
        const response = await fetch('/api/passwords', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: 'Shared Family Password',
            username: 'family@example.com',
            password: 'FamilyPassword456!',
            url: 'https://family-site.com',
            category: 'Personal',
            notes: 'Shared with family members',
            shared_with: familyMembers.map(m => m.id) // Share with all family members
          })
        });
        
        if (!response.ok) {
          const data = await response.json();
          resultEl.innerHTML = `<span class="error">❌ Failed to create shared password:\n${JSON.stringify(data, null, 2)}</span>`;
          console.error('Creation failed:', data);
        } else {
          const data = await response.json();
          resultEl.innerHTML = `<span class="success">✅ Shared password created successfully!</span>\n` +
            `ID: ${data.id}\n` +
            `Service: ${data.service_name}\n` +
            `Shared with: ${data.shared_with?.length || 0} users`;
        }
      } catch (error) {
        resultEl.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
        console.error('Error:', error);
      }
    }
    
    async function checkPasswords() {
      const resultEl = document.getElementById('list-result');
      resultEl.textContent = 'Fetching passwords...';
      
      try {
        const response = await fetch('/api/passwords');
        const data = await response.json();
        
        if (response.ok) {
          const passwords = data.passwords || [];
          if (passwords.length === 0) {
            resultEl.innerHTML = `<span class="warning">⚠️ No passwords found</span>`;
          } else {
            resultEl.innerHTML = `<span class="success">✅ Found ${passwords.length} passwords:</span>\n` +
              passwords.slice(0, 5).map(p => 
                `  - ${p.service_name || p.title} (${p.category}) - ${p.is_shared ? 'Shared' : 'Personal'}`
              ).join('\n');
          }
        } else {
          resultEl.innerHTML = `<span class="error">❌ Failed to fetch passwords: ${data.error}</span>`;
        }
      } catch (error) {
        resultEl.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
      }
    }
  </script>
</body>
</html>